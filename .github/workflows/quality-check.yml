name: Documentation Quality Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Mondays at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  link-checker:
    name: Check Documentation Links
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Check internal links
      run: |
        echo "Checking all markdown files for broken internal links..."
        python tools/validators/link-checker.py
        
    - name: Upload link check results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: link-check-results
        path: link-check-*.log
        retention-days: 30

  config-validator:
    name: Validate Configuration Examples
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install lxml
        
    - name: Validate XML templates
      run: |
        echo "Validating XML configuration templates..."
        if [ -f "templates/config-templates/types-xml-template.xml" ]; then
          python tools/validators/types-validator.py templates/config-templates/types-xml-template.xml
        fi
        
    - name: Check for common issues
      run: |
        echo "Checking for common documentation issues..."
        # Check for TODO markers
        TODO_COUNT=$(grep -r "TODO" docs/ --include="*.md" | wc -l || true)
        echo "Found $TODO_COUNT TODO markers"
        
        # Check for broken image references
        BROKEN_IMG=$(grep -r "!\[.*\](.*/.*)" docs/ --include="*.md" | grep -v "https://" | wc -l || true)
        echo "Found $BROKEN_IMG potential broken image references"

  python-tools-test:
    name: Test Python Tools
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install lxml pytest
        
    - name: Lint Python code
      run: |
        pip install flake8
        # Lint with relaxed rules for scripts
        flake8 tools/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
        
    - name: Test link checker
      run: |
        echo "Testing link checker..."
        python tools/validators/link-checker.py --help || python tools/validators/link-checker.py
        
    - name: Test config generator
      run: |
        echo "Testing config generator..."
        python tools/generators/config-generator.py TestMod "Test Author" /tmp/test-output
        ls -la /tmp/test-output/

  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Markdown Lint
      uses: articulate/actions-markdownlint@v1
      continue-on-error: true
      with:
        config: .markdownlint.json
        files: '**/*.md'
        ignore: node_modules

  file-structure-check:
    name: Verify File Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Check required files
      run: |
        echo "Checking for required files..."
        
        REQUIRED_FILES=(
          "README.md"
          "CONTRIBUTING.md"
          "LICENSE"
          "SECURITY.md"
          ".gitignore"
          "docs/ISSUE_INDEX.md"
          "docs/ECOSYSTEM.md"
          "docs/QUICKSTART.md"
        )
        
        MISSING=0
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ Missing: $file"
            MISSING=$((MISSING + 1))
          else
            echo "✅ Found: $file"
          fi
        done
        
        if [ $MISSING -gt 0 ]; then
          echo "Error: $MISSING required files are missing"
          exit 1
        fi
        
    - name: Verify directory structure
      run: |
        echo "Checking directory structure..."
        
        REQUIRED_DIRS=(
          "docs"
          "examples"
          "templates"
          "tools"
          "assets"
        )
        
        for dir in "${REQUIRED_DIRS[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "❌ Missing directory: $dir"
            exit 1
          else
            echo "✅ Found directory: $dir"
          fi
        done

  stats-report:
    name: Generate Statistics Report
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Count documentation files
      run: |
        echo "## Repository Statistics" > stats.md
        echo "" >> stats.md
        echo "- **Documentation Files**: $(find docs -name '*.md' | wc -l)" >> stats.md
        echo "- **Example Scripts**: $(find examples -name '*.c' -o -name '*.cpp' | wc -l)" >> stats.md
        echo "- **Templates**: $(find templates -type f ! -name 'README.md' | wc -l)" >> stats.md
        echo "- **Tools**: $(find tools -name '*.py' -o -name '*.sh' | wc -l)" >> stats.md
        echo "- **Total Markdown Files**: $(find . -name '*.md' | wc -l)" >> stats.md
        echo "- **Lines of Code**: $(find . -name '*.py' -o -name '*.c' -o -name '*.cpp' | xargs wc -l | tail -1)" >> stats.md
        cat stats.md
        
    - name: Upload statistics
      uses: actions/upload-artifact@v3
      with:
        name: repository-stats
        path: stats.md
